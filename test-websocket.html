<!DOCTYPE html>
<html>
<head>
    <title>WebSocket æµ‹è¯•</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <h1>Relay WebSocket æµ‹è¯•</h1>
    <div>
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€</button>
        <button onclick="getDeviceStatus()">è·å–è®¾å¤‡çŠ¶æ€</button>
        <button onclick="subscribeDevice()">è®¢é˜…è®¾å¤‡</button>
    </div>
    
    <div>
        <h3>è¿æ¥çŠ¶æ€ï¼š<span id="status">æœªè¿æ¥</span></h3>
        <h3>æ¶ˆæ¯æ—¥å¿—ï¼š</h3>
        <pre id="logs" style="background: #f0f0f0; padding: 10px; height: 400px; overflow-y: scroll;"></pre>
    </div>

    <script>
        let socket = null;
        const logs = document.getElementById('logs');
        const status = document.getElementById('status');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function connect() {
            if (socket) {
                socket.disconnect();
            }

            socket = io('ws://localhost:3000/relay');

            socket.on('connect', () => {
                status.textContent = 'å·²è¿æ¥';
                status.style.color = 'green';
                log('âœ… WebSocket è¿æ¥æˆåŠŸ!');
            });

            socket.on('disconnect', () => {
                status.textContent = 'å·²æ–­å¼€';
                status.style.color = 'red';
                log('âŒ WebSocket è¿æ¥æ–­å¼€');
            });

            socket.on('initialState', (data) => {
                log('ğŸ”„ åˆå§‹çŠ¶æ€: ' + JSON.stringify(data, null, 2));
            });

            socket.on('stateChanged', (event) => {
                log('ğŸ¯ çŠ¶æ€å˜åŒ–: ' + JSON.stringify(event, null, 2));
            });

            socket.on('deviceStatus', (data) => {
                log('ğŸ“Š è®¾å¤‡çŠ¶æ€: ' + JSON.stringify(data, null, 2));
            });

            socket.on('subscribed', (data) => {
                log('âœ… è®¢é˜…æˆåŠŸ: ' + JSON.stringify(data, null, 2));
            });

            socket.on('error', (error) => {
                log('ğŸ’¥ é”™è¯¯: ' + JSON.stringify(error, null, 2));
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function getDeviceStatus() {
            if (socket) {
                socket.emit('getDeviceStatus', { deviceId: 'device1' });
                log('ğŸ“¡ å‘é€è·å–è®¾å¤‡çŠ¶æ€è¯·æ±‚');
            } else {
                alert('è¯·å…ˆè¿æ¥WebSocket');
            }
        }

        function subscribeDevice() {
            if (socket) {
                socket.emit('subscribeDevice', { deviceId: 'device1' });
                log('ğŸ“‹ å‘é€è®¢é˜…è®¾å¤‡è¯·æ±‚');
            } else {
                alert('è¯·å…ˆè¿æ¥WebSocket');
            }
        }

        // è‡ªåŠ¨è¿æ¥
        connect();
    </script>
</body>
</html>
